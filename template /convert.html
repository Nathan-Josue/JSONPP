<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JONX Converter - Accueil</title>
  <link rel="stylesheet" href="stylesheet/style.css">

  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

</head>

<body class="body">

  <!-- Navigation avec liens vers pages séparées -->
  <nav class="nav-header">
    <div class="nav-container">
      <a href="index.html" class="nav-logo">JONX</a>
      <div class="nav-links">
        <a href="/" class="nav-link active">Accueil</a>
        <a href="about.html" class="nav-link">À propos</a>
        <a href="contact.html" class="nav-link">Contacter</a>
      </div>
      <a href="https://buymeacoffee.com/yourname" target="_blank" class="nav-cta">Buy Me a Coffee</a>
    </div>
  </nav>

  <div class="container">

    <header class="header">
      <h1 class="title">JONX Converter</h1>
      <p class="subtitle">Convertisseur JSON ↔ JSON++ (JONX)</p>
    </header>

    <div class="tabs">
      <button class="tab active" data-mode="decode">Décoder JONX → JSON</button>
      <button class="tab" data-mode="encode">Encoder JSON → JONX</button>
      <button class="tab" data-mode="create">Créer un format</button>
    </div>

    <section id="decodeSection" class="panel">
      <label class="label">Sélectionner un fichier JONX</label>
      <input
        type="file"
        id="decodeInput"
        accept=".json++,.jonx"
        class="file-input"
      >
    </section>

    <section id="encodeSection" class="panel hidden">
      <label class="label">Sélectionner un fichier JSON</label>
      <input
        type="file"
        id="encodeInput"
        accept=".json"
        class="file-input"
      >
      <button id="downloadBtn" class="btn hidden">Télécharger le fichier JONX</button>
    </section>

    <section id="createSection" class="panel hidden">
      <label class="label">Créer un JSON et voir le rendu JSON++</label>
      <div class="editor-container">
        <div>
          <label style="display: block; margin-bottom: 8px; color: var(--text-light); font-weight: 600;">Éditeur JSON</label>
          <div class="json-editor-container">
            <div id="jsonEditor"></div>
          </div>
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; color: var(--text-light); font-weight: 600;">Prévisualisation JSON++</label>
          <div id="previewPanel" class="preview-panel">Tapez du JSON valide pour voir la prévisualisation...</div>
        </div>
      </div>
    </section>

    <section id="output" class="panel output hidden"></section>

    <section id="jsonOutput" class="panel json-output hidden"></section>

  </div>

  <script>

    const tabs = document.querySelectorAll('.tab');
    const decodeSection = document.getElementById('decodeSection');
    const encodeSection = document.getElementById('encodeSection');
    const createSection = document.getElementById('createSection');
    const outputDiv = document.getElementById("output");
    const jsonDiv = document.getElementById("jsonOutput");

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const mode = tab.dataset.mode;

        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        decodeSection.classList.add('hidden');
        encodeSection.classList.add('hidden');
        createSection.classList.add('hidden');

        if (mode === 'decode') {
          decodeSection.classList.remove('hidden');
        } else if (mode === 'encode') {
          encodeSection.classList.remove('hidden');
        } else if (mode === 'create') {
          createSection.classList.remove('hidden');
          if (!monacoEditor && typeof require !== 'undefined') {
            initMonacoEditor();
          }
        }

        outputDiv.classList.add('hidden');
        jsonDiv.classList.add("hidden");
        document.getElementById('downloadBtn').classList.add('hidden');
      });
    });

    document.getElementById("decodeInput").addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;

      outputDiv.textContent = "Chargement et décodage du fichier...";
      outputDiv.classList.remove('hidden');
      jsonDiv.classList.add("hidden");
      jsonDiv.textContent = "";

      try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/api/decode', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          let info = "";
          info += `Fichier: ${result.file_name}\n`;
          info += `Taille: ${result.file_size.toLocaleString()} bytes\n\n`;
          info += `Format détecté: JONX (JSON++)\n\n`;
          info += `Informations:\n`;
          info += `   Version: ${result.version}\n`;
          info += `   Colonnes: ${result.fields.length}\n`;
          info += `   Lignes: ${result.num_rows.toLocaleString()}\n\n`;
          info += `Colonnes: ${result.fields.join(", ")}\n`;
          info += `Types: ${result.fields.map(f => `${f}:${result.types[f]}`).join(", ")}\n`;

          outputDiv.textContent = info;

          const jsonText = JSON.stringify(result.json_data, null, 2);
          jsonDiv.innerHTML = `<div class="json-title">JSON reconstruit:</div><pre>${jsonText}</pre>`;
          jsonDiv.classList.remove("hidden");

        } else {
          outputDiv.textContent = `Erreur: ${result.error}`;
          jsonDiv.classList.add("hidden");
        }

      } catch (error) {
        outputDiv.textContent = `Erreur: ${error.message}`;
        jsonDiv.classList.add("hidden");
      }
    });

    document.getElementById("encodeInput").addEventListener("change", async function () {
      const file = this.files[0];
      if (!file) return;

      const downloadBtn = document.getElementById('downloadBtn');
      outputDiv.textContent = "Chargement et encodage du fichier...";
      outputDiv.classList.remove('hidden');
      jsonDiv.classList.add("hidden");
      downloadBtn.classList.add('hidden');

      try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch('/api/encode', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = file.name.replace('.json', '.json++');
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          outputDiv.textContent = `✅ Fichier converti avec succès!\n\nFichier source: ${file.name}\nFichier généré: ${a.download}\n\nLe téléchargement a démarré automatiquement.`;
          downloadBtn.classList.add('hidden');
        } else {
          const result = await response.json();
          outputDiv.textContent = `Erreur: ${result.error || 'Erreur lors de la conversion'}`;
        }

      } catch (error) {
        outputDiv.textContent = `Erreur: ${error.message}`;
      }
    });

    const previewPanel = document.getElementById('previewPanel');
    let previewTimeout;
    let monacoEditor = null;

    function initMonacoEditor() {
      if (typeof require === 'undefined') {
        console.error('Monaco Editor loader not found');
        return;
      }

      require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
      require(['vs/editor/editor.main'], function () {
        const editorContainer = document.getElementById('jsonEditor');

        if (!editorContainer) {
          console.error('Editor container not found');
          return;
        }

        monaco.editor.defineTheme('jonx-dark', {
          base: 'vs-dark',
          inherit: true,
          rules: [],
          colors: {
            'editor.background': '#1a1a1a',
            'editor.foreground': '#e5e7eb',
            'editor.lineHighlightBackground': '#2a2a2a',
            'editor.selectionBackground': '#00d9a340',
            'editorCursor.foreground': '#00d9a3',
          }
        });
        monaco.editor.setTheme('jonx-dark');

        // Calculer les dimensions fixes une seule fois
        const container = editorContainer.parentElement;
        const calculateDimensions = () => {
          if (!container) return { width: 400, height: 400 };
          const rect = container.getBoundingClientRect();
          return {
            width: Math.max(rect.width - 4, 400), // -4 pour les bordures
            height: 400
          };
        };

        // Initialiser avec des dimensions fixes
        const initialDimensions = calculateDimensions();
        editorContainer.style.width = initialDimensions.width + 'px';
        editorContainer.style.height = initialDimensions.height + 'px';
        editorContainer.style.maxWidth = '100%';
        editorContainer.style.maxHeight = '400px';
        editorContainer.style.overflow = 'hidden';

        monacoEditor = monaco.editor.create(editorContainer, {
          value: `[\n  {"id": 1, "name": "Produit 1", "price": 100, "category": "Électronique"},\n  {"id": 2, "name": "Produit 2", "price": 200, "category": "Vêtements"}\n]`,
          language: 'json',
          theme: 'jonx-dark',
          automaticLayout: false,
          minimap: { enabled: false },
          fontSize: 14,
          lineNumbers: 'on',
          roundedSelection: false,
          scrollBeyondLastLine: false,
          readOnly: false,
          wordWrap: 'on',
          formatOnPaste: true,
          formatOnType: true,
          tabSize: 2,
          insertSpaces: true,
          suggestOnTriggerCharacters: true,
          acceptSuggestionOnEnter: 'on',
          quickSuggestions: true,
        });

        // Layout initial avec dimensions fixes
        monacoEditor.layout({
          width: initialDimensions.width,
          height: initialDimensions.height
        });

        // Gérer uniquement le redimensionnement de la fenêtre (pas le conteneur)
        let windowResizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(windowResizeTimeout);
          windowResizeTimeout = setTimeout(() => {
            if (monacoEditor && container) {
              const dims = calculateDimensions();
              // Ne mettre à jour que si les dimensions ont vraiment changé
              const currentWidth = parseInt(editorContainer.style.width) || dims.width;
              const currentHeight = parseInt(editorContainer.style.height) || dims.height;
              
              if (Math.abs(currentWidth - dims.width) > 5 || Math.abs(currentHeight - dims.height) > 5) {
                editorContainer.style.width = dims.width + 'px';
                editorContainer.style.height = dims.height + 'px';
                monacoEditor.layout({
                  width: dims.width,
                  height: dims.height
                });
              }
            }
          }, 250);
        });

        monacoEditor.onDidChangeModelContent(() => {
          clearTimeout(previewTimeout);
          previewTimeout = setTimeout(updatePreview, 300);
        });

        updatePreview();
      });
    }

    if (typeof require !== 'undefined') {
      setTimeout(initMonacoEditor, 100);
    } else {
      window.addEventListener('load', function() {
        if (typeof require !== 'undefined') {
          setTimeout(initMonacoEditor, 100);
        }
      });
    }

    async function updatePreview() {
      if (!monacoEditor) return;

      const jsonText = monacoEditor.getValue().trim();

      if (!jsonText) {
        previewPanel.innerHTML = '<div class="preview-placeholder">✨ Tapez du JSON valide pour voir la prévisualisation...</div>';
        previewPanel.className = 'preview-panel styled';
        return;
      }

      try {
        const jsonData = JSON.parse(jsonText);

        if (!Array.isArray(jsonData)) {
          previewPanel.innerHTML = '<div class="preview-error">⚠️ Erreur: Le JSON doit être un tableau (array)</div>';
          previewPanel.className = 'preview-panel styled';
          return;
        }

        if (jsonData.length === 0) {
          previewPanel.innerHTML = '<div class="preview-error">⚠️ Erreur: Le tableau ne peut pas être vide</div>';
          previewPanel.className = 'preview-panel styled';
          return;
        }

        const response = await fetch('/api/preview', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ data: jsonData })
        });

        if (!response.ok) {
          const error = await response.json();
          previewPanel.innerHTML = `<div class="preview-error">⚠️ Erreur: ${error.detail || 'Erreur lors de la prévisualisation'}</div>`;
          previewPanel.className = 'preview-panel styled';
          return;
        }

        const result = await response.json();

        if (result.success) {
          let previewHTML = `
            <div class="preview-info-section">
              <div class="preview-label">Fichier</div>
              <div class="preview-value">data_jonx.json++</div>
              <div class="preview-label">Taille</div>
              <div class="preview-value"><span class="preview-highlight">${result.estimated_size.toLocaleString()}</span> bytes</div>
            </div>

            <div class="preview-info-section">
              <div class="preview-label">Format détecté</div>
              <div class="preview-format-badge">JONX (JSON++)</div>
            </div>

            <div class="preview-info-section">
              <div class="preview-label">Informations</div>
              <div class="preview-stats">
                <div class="preview-stat-item">
                  <span class="preview-stat-value">${result.version}</span>
                  <span class="preview-stat-label">Version</span>
                </div>
                <div class="preview-stat-item">
                  <span class="preview-stat-value">${result.fields.length}</span>
                  <span class="preview-stat-label">Colonnes</span>
                </div>
                <div class="preview-stat-item">
                  <span class="preview-stat-value">${result.num_rows.toLocaleString()}</span>
                  <span class="preview-stat-label">Lignes</span>
                </div>
              </div>
            </div>

            <div class="preview-info-section">
              <div class="preview-label">Colonnes</div>
              <div class="preview-columns-list">${result.fields.join(", ")}</div>
            </div>

            <div class="preview-info-section">
              <div class="preview-label">Types</div>
              <div class="preview-types-list">${result.fields.map(f => `${f}: <span class="preview-highlight">${result.types[f]}</span>`).join(", ")}</div>
            </div>
          `;

          previewPanel.innerHTML = previewHTML;
          previewPanel.className = 'preview-panel styled';
        } else {
          previewPanel.innerHTML = `<div class="preview-error">⚠️ Erreur: ${result.error || 'Erreur inconnue'}</div>`;
          previewPanel.className = 'preview-panel styled';
        }
      } catch (error) {
        if (error instanceof SyntaxError) {
          previewPanel.innerHTML = `<div class="preview-error">⚠️ Erreur de syntaxe JSON: ${error.message}</div>`;
        } else {
          previewPanel.innerHTML = `<div class="preview-error">⚠️ Erreur: ${error.message}</div>`;
        }
        previewPanel.className = 'preview-panel styled';
      }
    }
  </script>

</body>
</html>
